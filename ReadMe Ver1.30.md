### ReadMe Ver1.40
# GPSルート表示・誘導・記録 Ver1.30

## 概要

このプロジェクトは、WebブラウザのGeolocation APIとLeaflet.jsライブラリを組み合わせて、ユーザーの現在の位置を地図上に表示し、GPX形式のルートファイルを読み込んだり、地図をクリックして目的地を設定したりして、ルート案内を行うWebアプリケーションです。GPS追跡中は、移動履歴をGPXファイルとして保存する機能も備わっています。

## 特徴

*   **GPXルートの読み込みと表示**: GPX形式のルートファイルをアップロードし、地図上に青いラインで表示します。
*   **マップクリックで目的地設定とルーティング**:
    *   地図上の任意の場所をクリックすると、その地点が目的地として設定され、赤いマーカーが表示されます。
    *   現在地（取得済みの場合）から目的地までのルートが、OSRM (Open Source Routing Machine) を利用して自動的に計算され、地図上に赤いラインで表示されます。
*   **現在地表示と追跡**:
    *   「現在地を表示」ボタンで、一度だけ現在のGPS位置情報を取得し、地図に表示します。
    *   「誘導を開始」ボタンを押すと、GPS追跡が開始され、ユーザーの現在地が地図の中心に自動で追跡表示されます。現在地マーカーをクリックすると、精度情報が表示されます。
*   **リアルタイムルート誘導**:
    *   アクティブなルート（GPXルートまたは目的地ルート）に沿って誘導を行います。
    *   現在地からルートの終点までの残りの距離をリアルタイムで表示します。
    *   現在地からアクティブなルート上の最も近い地点までの距離を表示し、ルートからのずれを把握できます。
    *   目的地ルートの場合、ユーザーの移動に合わせてルートの始点が現在地に追従し、リアルタイムで経路案内を更新します。
*   **GPS履歴の記録と保存**:
    *   「**記録開始**」ボタンを押すと、GPS位置情報の記録が開始されます。誘導機能とは独立して記録できます。
    *   「**記録終了**」ボタンを押すと、記録が停止し、その時点までのGPSログが `yyyymmdd.gpx` 形式のGPXファイルとして自動でダウンロード保存されます。
*   **地図の自動調整**: GPXルート読み込み時、目的地ルート計算時、および現在地追跡中に地図の表示範囲とズームレベルを自動調整します。
*   **柔軟なルートクリア機能**:
    *   「ルートクリア」ボタンで、現在表示されている全てのルート（GPX/目的地）と目的地マーカーを一度に削除できます。誘導中や記録中の場合は、それらも停止します。
    *   新しいGPXファイルを読み込んだり、マップをクリックして新しい目的地を設定したりすると、既存のもう一方のルート（目的地ルートまたはGPXルート）は自動的にクリアされます。
*   **エラーハンドリング**: 位置情報の取得失敗時（権限拒否、利用不可、タイムアウトなど）に適切なメッセージを表示します。
*   **レスポンシブデザイン**: コントロールパネルと地図表示パネルを分離し、携帯電話などの小さい画面でもバランス良く表示されるように最適化されています。
*   **画面タイトル表示**: アプリケーションのタイトルが画面上にも表示されます。

## 動作環境

*   現代のWebブラウザ (Chrome, Firefox, Safari, Edgeなど)
*   位置情報サービスへのアクセスを許可していること
*   インターネット接続 (OSRMルーティングサービス、OpenStreetMapタイルにアクセスするため)

## 使用方法

1.  `index.html` ファイルをWebサーバーに配置するか、直接ブラウザで開きます。
    *   ファイルを直接開く場合 (例: `file:///path/to/index.html`)、一部のブラウザではセキュリティ上の理由から位置情報サービスが正しく動作しない場合があります。
    *   簡単なローカルサーバー (例: `python -m http.server`) を使用することを推奨します。

2.  ブラウザでページを開くと、「GPXファイルを読み込むか、マップをクリックして目的地を設定してください。」というメッセージが表示されます。

3.  **ルートを設定する方法 (いずれかを選択):**
    *   **GPXファイルを読み込む場合:** 「ファイルを選択」ボタンをクリックし、`*.gpx` 形式のルートファイルをアップロードします。
        *   GPXファイルが正常に読み込まれると、地図上に青いラインでルートが表示され、「誘導を開始」ボタンが有効になります。同時に、設定済みの目的地ルートはクリアされます。
    *   **マップクリックで目的地を設定する場合:** 地図上の任意の場所をクリックします。
        *   クリックした場所に赤い目的地マーカーが表示され、現在地（取得済みの場合）から目的地までのルートが赤色のラインで自動的に計算・表示されます。「誘導を開始」ボタンが有効になります。同時に、読み込み済みのGPXルートはクリアされます。

4.  **誘導を開始する:**
    *   ルート（GPXまたは目的地）が設定され、「誘導を開始」ボタンが有効になったら、それをクリックします。
    *   ブラウザから位置情報サービスの利用許可を求められた場合は、「許可」または「Allow」を選択してください。
    *   誘導が開始されると、現在地が地図上にマーカーとして表示され、地図が現在地を中心にズームされます。画面下部には、ルート終点までの距離やルートからのずれが表示されます。

5.  **誘導を停止する:**
    *   誘導を停止したい場合は、「**誘導を停止**」ボタンをクリックします。現在地の追跡とルート誘導が停止します。

6.  **GPS履歴の記録を開始する:**
    *   「**記録開始**」ボタンをクリックします。
    *   ブラウザから位置情報サービスの利用許可を求められた場合は、「許可」または「Allow」を選択してください。
    *   GPS位置情報の記録が開始され、移動履歴がバックグラウンドで保持されます。

7.  **GPS履歴の記録を終了して保存する:**
    *   記録を終了したい場合は、「**記録終了**」ボタンをクリックします。
    *   記録が停止し、その時点までのGPS履歴が `yyyymmdd.gpx` というファイル名で自動的にダウンロードされます。

8.  **ルートをクリアする:**
    *   表示されているGPXルート、または設定されている目的地マーカーとルートを全て削除したい場合は、「**ルートクリア**」ボタンをクリックします。誘導中や記録中の場合は、それらも停止します。

9.  「**現在地を表示**」ボタンは、誘導中や記録中ではないときに一度だけ現在地を取得して表示したい場合に使用します。

## 技術スタック

*   **HTML5**: ページの構造
*   **CSS3**: スタイリング (レスポンシブデザインを含む)
*   **JavaScript**:
    *   **Geolocation API**: ブラウザからユーザーの現在地情報を取得し、継続的に追跡するために使用。
    *   **Leaflet.js**: オープンソースのインタラクティブマップライブラリ。地図の表示、GPXトラックの描画、マーカーの追加、地図操作などに使用。
    *   **Leaflet Routing Machine**: Leaflet用のルーティングプラグイン。OSRMなどのルーティングサービスを利用して経路計算と表示を行います。
    *   **OSRM (Open Source Routing Machine)**: 経路計算のためのバックエンドサービス (Leaflet Routing Machine経由で利用)。
    *   **DOMParser**: GPXファイルをXMLとして解析するために使用。
    *   **FileReader**: ユーザーが選択したGPXファイルを読み込むために使用。
    *   **Blob API / URL.createObjectURL**: 記録されたGPS履歴からGPXファイルを生成し、ダウンロードをトリガーするために使用。
    *   **OpenStreetMap**: Leaflet.jsで表示される地図のタイルプロバイダー。

## ファイル構成

```
.
└── index.html
```

## ライセンス

このプロジェクトは特にライセンスを定めていません。自由にご利用ください。

---
**ReadMe Version 1.30**