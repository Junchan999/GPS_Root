# GPS表示・誘導・記録 アプリ ReadMe Ver1.40

## 概要

このウェブアプリケーションは、Leaflet.jsとLeaflet Routing Machineを活用し、ユーザーの現在地表示、GPXルートの表示と誘導、およびGPS履歴の記録・保存機能を提供します。シンプルなUIで、モバイルデバイスでも使いやすいように設計されています。

## 機能

*   **現在地表示**: GPSを利用してユーザーの現在の位置を地図上に表示します。
*   **GPXルート表示**: GPXファイルを読み込み、そのルートを地図上に描画します。GPX 1.1の名前空間を含むファイルにも対応しています。
*   **GPXルート誘導**: 読み込んだGPXルートに沿って、現在地からの残り距離とルートからのずれを表示し、誘導します。
*   **目的地設定と誘導**: 地図をクリックして目的地を設定し、現在地から目的地までのルートを計算・表示し、誘導します。ルートは動的に現在地を追従します。
*   **GPS履歴記録**: 設定した時間間隔（秒単位）で現在地のGPS座標を記録し、移動履歴として保存します。
*   **GPXファイル保存**: 記録されたGPS履歴をGPX 1.1形式のファイルとしてダウンロードできます。
*   **ルート/マーカークリア**: 表示されているすべてのルート、マーカー、および記録履歴をクリアします。
*   **レスポンシブデザイン**: スマートフォンなどの小さい画面でも操作しやすいようにレイアウトが最適化されています。

## 使い方

### 1. アプリの起動

`index.html`ファイルをウェブブラウザで開きます。

### 2. 現在地表示

*   **「現在地を表示」ボタン**: クリックすると、現在のGPS位置を地図上にマーカーで表示します。追跡は一度きりです。誘導や記録を開始すると、継続的な追跡が自動的に開始されます。

### 3. GPXルートの読み込みと表示

*   **「ファイルを選択」 (GPXファイル入力欄)**: `.gpx`ファイルを指定して読み込みます。
    *   読み込まれると、そのGPXトラックが青い線で地図上に描画され、地図がルート全体にズームします。
    *   すでに設定されている目的地ルートは自動的にクリアされます。

### 4. 目的地設定と誘導

*   **地図をクリック**: 地図上の任意の場所をクリックすると、その地点に赤いマーカーが「目的地」として設定されます。
*   現在地が既に取得されていれば、現在地から目的地までのルートが赤線で計算・表示されます。
*   **「誘導を開始」ボタン**: 目的地ルートが設定されている場合、このボタンをクリックすると誘導が開始されます。
    *   現在地マーカーが地図の中心に追従し、目的地までの残り距離とルートからのずれが表示されます。
    *   現在地が更新されると、ルートも動的に再計算され、現在地からのルートが常に表示されます。
*   **「誘導を停止」ボタン**: 誘導を停止します。

### 5. GPXルート誘導

*   GPXファイルが読み込まれた状態で**「誘導を開始」ボタン**をクリックすると、GPXルートに沿った誘導が開始されます。
    *   現在地マーカーが地図の中心に追従し、GPXルートの終点までの残り距離と、GPXルートからのずれが表示されます。
*   **「誘導を停止」ボタン**: 誘導を停止します。

### 6. GPS履歴の記録と保存

*   **「記録間隔」入力欄**: GPS位置を記録する間隔を秒単位で設定します（デフォルト: 5秒）。
*   **「記録開始」ボタン**: クリックすると、設定された間隔で現在地を記録し始めます。
    *   記録中は「記録終了」ボタンが有効になります。
*   **「記録終了」ボタン**: クリックすると記録を停止し、記録された履歴を`YYYYMMDD_HHMM.gpx`というファイル名で自動的にダウンロードします。（`YYYYMMDD_HHMM`は日本時間）

### 7. ルート/マーカーのクリア

*   **「ルートクリア」ボタン**: 地図上のGPXルート、目的地マーカー、現在地マーカー、および現在進行中の誘導や記録をすべて停止し、地図をクリアします。

## 技術スタック

*   **HTML5**: アプリケーションの構造
*   **CSS3**: スタイリング、レスポンシブデザイン
*   **JavaScript**: アプリケーションロジック
    *   **Leaflet.js v1.9.4**: 地図表示ライブラリ
    *   **Leaflet Routing Machine v3.2.12**: ルーティング機能（OSRM Public APIを使用）

## 注意事項

*   **位置情報サービス**: 本アプリは位置情報サービスを利用します。ブラウザで位置情報へのアクセスを許可してください。
*   **インターネット接続**: Leafletのタイル表示やLeaflet Routing Machineのルーティングサービス（OSRM Public API）を利用するため、インターネット接続が必要です。
*   **GPXファイルのXML形式**: 読み込むGPXファイルはXMLの仕様に厳密に準拠している必要があります。特に、XML特殊文字（例: `&`）は`&amp;`のようにエスケープされている必要があります。
*   **GPS精度**: 位置情報の精度は、デバイスのGPS性能や周囲の環境に依存します。
*   **バッテリー消費**: 継続的なGPS追跡や画面表示はバッテリーを多く消費する可能性があります。

## バージョン履歴

*   **Ver1.00**: 初版。GPXルート表示アプリとして公開。
*   **Ver1.10**: 現在地表示機能、地図クリックでの目的地設定機能、Leaflet Routing Machineによるルーティング表示機能を追加。
*   **Ver1.20**: 目的地までのルート誘導機能を追加。現在地からの距離とルートからのずれを表示。
*   **Ver1.30**: GPS履歴の記録・保存機能を追加。記録間隔設定、GPXファイルダウンロードに対応。GPXファイル解析の堅牢性を向上（名前空間対応、エラーハンドリング強化）。
*   **Ver1.40**: 記録機能で保存されるGPXファイル内の`creator`属性がXML仕様に準拠するよう修正（`&`を`&amp;`にエスケープ）。

---