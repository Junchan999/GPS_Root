# GPS表示・誘導・記録 Ver1.60

## 概要

このWebアプリケーションは、現在地のGPS情報を地図上に表示し、GPXファイルやユーザーが設定した目的地へのルート誘導、そして移動履歴のGPS記録を行うためのツールです。スマートフォンなどのモバイルデバイスでも使いやすいように設計されています。

## 特徴

*   **現在地表示**: 現在のGPS位置を地図上にリアルタイムで表示します。
*   **GPXルート表示と誘導**: GPXファイルを読み込み、そのトラックを地図上に表示します。読み込んだGPXルートに沿って現在地からの距離やルートからのずれを誘導します。
*   **目的地へのルーティングと誘導**: マップをクリックすることで任意の地点を目的地に設定し、現在地からそこまでの最適なルートを計算・表示します。目的地までの残り距離やルートからのずれを誘導します。
*   **GPS履歴の記録**: 移動した経路のGPSデータを自動的に記録します。記録間隔を秒単位で設定可能です。
*   **GPX形式での保存**: 記録したGPS履歴を標準的なGPXファイル形式でダウンロードできます。
*   **高度（標高）データの記録**: 記録されるGPXデータには、緯度・経度・時刻に加え、高度情報も含まれます。
*   **モバイルフレンドリーなUI**: 携帯電話などの小さい画面でも操作しやすいよう、レスポンシブなデザインを採用しています。
*   **ルートクリア機能**: 表示中のルート（GPXまたは目的地ルート）、マーカー、記録履歴を一度にクリアできます。
*   **画面OFF防止機能**: 誘導中または記録中に携帯電話の画面が自動的にオフになるのを防ぎ、アプリの動作が中断されないようにします（Wake Lock APIを使用）。

## Ver1.60での主な変更点

*   **画面OFF防止機能を追加しました。** GPSによる誘導中または記録中に、Web標準のWake Lock APIを利用して、デバイスの画面が自動的にオフになることを防止するようになりました。これにより、長時間の移動記録や誘導中にアプリの動作が中断されるリスクを低減します。

## 使い方

1.  **アプリケーションの起動**: `index.html`ファイルをWebブラウザで開きます。
2.  **現在地の表示**:
    *   「現在地を表示」ボタンをクリックすると、現在地のGPS情報を取得し、地図上にマーカーで表示します。地図は現在地を中心に移動します。
    *   初回利用時にはブラウザから位置情報利用の許可を求められますので、許可してください。
3.  **GPXファイルの読み込み**:
    *   「ファイルを選択」ボタンをクリックし、GPXファイルを選択して読み込みます。
    *   GPXトラックが青い線で地図上に表示され、地図がルート全体が収まるようにズームされます。
4.  **目的地設定とルート誘導**:
    *   地図上の任意の場所をクリックすると、その地点に赤いマーカーが表示され、そこが目的地として設定されます。
    *   現在地が取得済みであれば、現在地から目的地までのルートが赤い線で計算・表示されます。
5.  **誘導の開始・停止**:
    *   GPXルートまたは目的地が設定されている状態で「誘導を開始」ボタンをクリックすると、現在地を追跡しながら、ルートからの距離や目的地までの残り距離がメッセージとして表示されます。この際、画面OFF防止機能が有効になります。
    *   「誘導を停止」ボタンで誘導を終了します。誘導が終了すると画面OFF防止機能は自動で解除されます。
6.  **GPS記録の開始・停止・保存**:
    *   「記録開始」ボタン（緑色）をクリックすると、現在地のGPS履歴の記録を開始します。この際、画面OFF防止機能が有効になります。
    *   「記録間隔」入力フィールドで、記録する間隔を秒単位で設定できます。（デフォルト: 5秒）
    *   「記録終了」ボタン（赤色）をクリックすると、記録を停止し、それまでのGPS履歴をGPXファイルとしてダウンロードするダイアログが表示されます。ファイル名は自動的に「YYYYMMDD\_HHMM.gpx」（日本時間）となります。記録が終了すると画面OFF防止機能は自動で解除されます。
7.  **ルート・マーカーのクリア**:
    *   「ルートクリア」ボタン（赤色）をクリックすると、表示中のGPXルート、目的地マーカー、ルーティング結果、および記録履歴が全てクリアされます。誘導中または記録中であれば、それらも停止し、画面OFF防止機能も解除されます。

## 技術スタック

*   **フロントエンド**: HTML, CSS, JavaScript
*   **マップライブラリ**: [Leaflet.js](https://leafletjs.com/) (Ver 1.9.4)
*   **ルーティングライブラリ**: [Leaflet Routing Machine](https://github.com/perliedman/leaflet-routing-machine) (Ver 3.2.12)
*   **タイルマップ**: OpenStreetMap
*   **ルーティングサービス**: [OSRM Public API](http://project-osrm.org/)

## 注意事項

*   **位置情報サービスの許可**: アプリケーションの機能を利用するためには、ブラウザで位置情報サービスの利用を許可する必要があります。
*   **インターネット接続**: ルーティング機能（OSRM API）やタイルマップの表示にはインターネット接続が必要です。GPXファイルの読み込みとGPS履歴の記録・保存はオフラインでも動作します。
*   **高度データの精度**: GPSデバイスや環境によっては、高度データの精度が緯度・経度データに比べて低い場合があります。
*   **ブラウザ互換性**: 最新のWebブラウザ（Chrome, Firefox, Edge, Android標準ブラウザなど）での動作を想定しています。Wake Lock APIはすべてのブラウザで完全にサポートされているわけではありません（特にiOS Safariなど）。
*   **バッテリー消費**: GPSの継続的な追跡と画面OFF防止機能は、デバイスのバッテリーを消費します。長時間の利用には、デバイスの充電状況にご注意ください。
*   **Wake Lock APIの挙動**: Wake Lock APIはユーザーの操作によってトリガーされる必要があり、またブラウザやOSのポリシーによって動作が制限されることがあります。例えば、ブラウザがバックグラウンドに移動すると、一時的にWake Lockが解放される場合がありますが、アプリがフォアグラウンドに戻った際に再要求を試みます。

## バージョン履歴

*   **Ver1.00**: 初期リリース (現在地表示、基本的なGPX読み込み)
*   **Ver1.10**: 目的地設定と簡易ルーティング機能の追加
*   **Ver1.20**: GPS履歴記録機能の追加、UI調整
*   **Ver1.30**: (コード内のタイトル表記)
*   **Ver1.40**: UIの改善、モバイル対応強化、記録間隔設定機能の追加
*   **Ver1.50**: GPS記録に高度（標高）データの記録とGPXへの出力に対応
*   **Ver1.60**: 画面OFF防止機能（Wake Lock API）の追加